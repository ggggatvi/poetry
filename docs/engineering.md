# 開発周りのゆるいはなし

## はじめに

ここでのエンジニアリング力とは、ターミナルの操作やPythonによるコーディング、AWSサービスの利用など、アイデアを実現するために必要な技術力のことを指します。
エンジニアリング力は研究開発を円滑に進める強力な手助けとなります。

例えば、プロトタイプアプリケーションを作り、価値検証を行いたいとします。
手元に開発済みのモデルがあるのであれば、あとはWebAPIと簡単なHTMLを作ることで実現できます。
Webアプリケーションだと簡単に触ってもらえますし、何より触ってもらうことで意見・感想をもらうことができます。
また、プロダクション利用を前提にコードを書く場合には、Dockerによるコンテナ化やロギングの仕組みなどが必要です。
もちろん、開発者に丸投げということもできるでしょう。
ただ、コンテナ化の方法や利点・欠点を知っておくことで、開発者に依頼する際の円滑さも変わってくるはずです。

このページでは、研究開発をする上で頻繁に利用する開発周りのことについて、ゆるく紹介します。

## ターミナルになじむ(黒い画面アレルギーを無くそう)

ターミナルとは、コマンドラインインターフェイスにより任意の操作が可能となるアプリケーションです。
コマンドラインインターフェイスとは、文字列を入力として記述し、処理結果の文字列が出力されるものです。

LinuxやMacのターミナルは強力なツールを備えており、単純な集計やファイルの前処理を簡単かつ高速に行うことができます。
例えばファイルのソートは、sortコマンドで行えますし、CSVファイルのある列を取り出したい場合は、 cut コマンドで実現できます。

入力と出力の概念を紹介します。
コマンドに対して、基本的にはデータを流しこみ、データを出力します。
この入出力は標準入出力と呼ばれます。
デフォルトでは、標準入力はキーボード、標準出力はターミナル上となります。
この標準入出力のつなぎ込みを変えられるというのが最大の特徴です。
例えば、標準入出力をファイルに変更することが可能です。
また、このつなぎ込みの機能の一つにパイプラインがあります。
これは、コマンド間で標準入出力をつなぎこむことで、より複雑な処理を実現します。
例えば、ソートした後に3文字のものだけ残すといったことが可能となります。

プログラマーは怠惰であるというひどい言われようですが、そんな私も怠惰な人間のうちの一人です。
環境構築が非常に非常に面倒くさいため、自動化しています([参考](https://jp.corp-sansan.com/mimi/2017/10/tech5-shell.html))。
こういったスクリプトも裏側は実はただコマンドが走っているだけです。
CLIは自動化と相性がいいため、ぜひ使ってみてください。

## 行単位の処理に慣れよう

ファイルを全部読み込んでから実行なんていう富豪プログラミングをしていませんか？
1行ずつ処理できるように記述ができれば、前節のターミナル上で完結したり、メモリ少なく処理できたりと、利点がたくさんあります。
もちろんファイル全体から算出した統計量を使う場合などは、行単位では処理できないですので、方法を考える必要があります。

Pythonでとりあえず read メソッドを使うのはやめましょう。次のように yield を用いて実行するといいでしょう。

```python
def iter_line(filename):
    with open(filename, mode="rt") as fin:
        for line in fin:
            do_some_process
            yield line
```

## みんなつまずくSSHによるログイン

ターミナルを使う上で、おそらく最初に覚えることは、 SSH でのログイン方法です。
そもそもSSHとは何の略でしょうか。
SSH とは Secure SHell の略称です。
安全にリモートサーバと通信するためのプロトコルのことです。
安全に通信するために、認証や暗号化といったものが組み込まれています。
そしてこれらが、SSH を利用する上での設定での関門となっています。
仕組みを知れば、何ともないものですので、順に説明していきます。

SSHコマンドは単純です。公開鍵認証を使うとした場合、次のコマンドが例となります。

```sh
ssh -i identity_file user@hostname
```

鍵の作成は、 `ssh-keygen` コマンドで行います。手元の `~/.ssh` ディレクトリ以下に秘密鍵を配置します。なお、ディレクトリのパーミッションと秘密鍵のパーミッションは `600` に設定しておいてください（所有ユーザしか読み書きできない）。公開鍵はログイン先サーバの `~/.ssh/authorized_keys` に追記します。一行に一公開鍵です。

はじめに特につまずくのが、踏み台経由でのログインです。
企業ではセキュリティの都合上入り口を一つに絞りネットワークを分けます。
つまり踏み台サーバにログインした後に、任意のサーバにログインします。
ログインが毎回大変になるため、便利な `~/.ssh/config` の設定をします。

```sh
Host prod-gateway
     HostName 踏み台のIPアドレス(例:xxx.xxx.x.x)
     Port 踏み台のポート(例:22)
     User ユーザ名
     IdentityFile "秘密鍵のファイル名"
     
Host dev-001
     HostName 開発環境のIPアドレス
     Port 開発環境のポート
     User ユーザ名
     ProxyCommand ssh -W %h:%p prod-gateway
     IdentityFile "秘密鍵のファイル名"
     LocalForward 8080 localhost:8080
```

LocalForwardはポート転送の設定です。
Jupyter NotebookやR Studioを使った開発を行う際に、便利です。
リモートホストの特定のポートを手元に転送します。

さて、ここまで設定できたら、後は `ssh dev-001` と入力すると、踏み台を経由してログインすることが可能となります。

## きちんと使うGit

Gitは難しいので、「main_backup.py」みたいに名前を変えて保存をしておけばよいと考えていませんか。
こういった場合に、あとで訳がわからなくなるならないように、バージョン管理システムができています。
バージョン管理システムとは単なるバックアップではありません。
文字通りバージョンを管理します。

バージョンとは何でしょうか。
あるコード群のある時点のものといえるでしょう。
クラスを追加するたびに、別名で保存するというわけにはいきません。
また、ちょこっとお試しで変更を加えたい場合や、変更が何に対するものか記録したい、さらには複数人でうまく変更を共有したいとなってくるでしょう。
実はこれらはGitで解決されます。

分散型バージョン管理システムである Git はコマンドラインアプリケーションとして提供されています。

## Python(蛇を操る)

https://docs.python.org/ja/3/index.html

Python は機械学習モデルの開発やWebアプリケーション開発に使われる言語です。
特に機械学習では標準的な言語となっています。
Pythonは型を宣言する必要がなく、またコンパイルが不要であるため、試行錯誤することには適しています。
運用を考えた際には、よく考えられたコーディングというのは難しいので少しずつ技術を身につけていきましょう。

### print デバッグはやめて、ロギングを使おう

もしかして途中結果を確認するために、print 文を書いては消してなんていうことをやっていませんか。
もうコメントアウトは必要ありません。
そうロギングがあれば。

https://docs.python.org/ja/3/howto/logging.html

ここに Python での logging について詳細に説明されています。
すべて読むのは大変ですが、一読することをお勧めします。
中でも重要な項目を一部抜粋して紹介します。

logging は、プログラムの途中経過などを記録するためのモジュールです。
ログ出力においてログレベルという概念を持っており、デバッグやエラーといったように区分けされています。
レベルを考慮したログ出力というのが、コードを見ると一目でわかるということです。

```python
import logging


logging.warning("Warning")
logging.info("Information")
```

上記のようにロギングを書くことは可能です。
しかしながら、実際のプログラムというのは様々なモジュールやクラス、メソッドが実行されます。
そういったものに対してログを記録する際には、モジュールレベルロガーを使いましょう。

```python
logger = logging.getLogger(__name__)
```

### itertoolsという便利な車輪を使おう

https://buildersbox.corp-sansan.com/entry/tech19_itertools

https://more-itertools.readthedocs.io/en/stable/

itertools は非常に強力なライブラリです。
何が強力かって聞く前に使うことでわかるくらい強力なライブラリです。
組み合わせをとるときや、条件に合致し続けるものをとり続けるといったものを実装していませんか？
車輪の再発明というのは大事なことですが、ライブラリというものはある種の共通言語となります。
しっかりとした命名規則とリファレンスがあることから、何をやっているかが明確になります。
さらに効率の良い実装がなされています。

### scikit-learn の恩恵を預かろう

https://scikit-learn.org/stable/

scikit-learn が提供するのは単なる機械学習ライブラリではなく、機械学習を進めるために必要なあれこれが詰まったライブラリです。
例えば、評価やパラメータ探索などを含みます。
また、自分でモデルを実装する際に scikit-learn のお作法に則ることで、これらの有益なライブラリを十分に活かすことができます。(参考：[Developing scikit-learn estimators](https://scikit-learn.org/stable/developers/develop.html#developing-scikit-learn-estimators))

### スパゲッティノートブックはほどけない

私は料理は得意ではありませんが、ノートブックでいつもスパゲッティを作ってしまいます。
そして一日経つとそれはもう目を当てられない異形の姿と成り果てます。
自分の書いたものが異形の姿になるというのは避けたいところです。
いくつかノートブックを書く上で注意していることを紹介します。

* 上から順に実行して動くようにその日のうちにしておく
* 適当な変数名はつけない
* とりあえず生ビールの気分でとりあえずノートブックを作らない
* コメントは書いておく
* 中間データは極力作らない

## クラウドサービス

### AWS

Amazon Web Services の略です。
コンピュータを使ったシステムを作る際に、クラウドで様々な機能を提供します。
例えば、仮想マシンを提供する EC2(Elastic Compute Cloud) やファイルストレージである S3(Simple Storage Service)などがあります。
概念がたくさんあるため覚えることが多く、最初は難しく感じるかもしれません。
ただ皆さんは宇宙船地球号に乗船していますが、すべては知らないはずです。
そんな感じであまりにも巨大なので使えるところから使っていきましょう。

まず抑えておくことは、リージョンと権限です。
リージョンとは、クラウド上のサービスの実体がどこにあるかを指し示すものです。
サービスによっては国内リージョンに限定するという仕様があるかもしれません。
また、リージョンによって新機能が未導入ということがあります。

次に、権限です。
AWS Identity and Access Management(通称IAM)と呼ばれる、AWSのサービスとリソースへのアクセスを管理するサービスです。
先ほどのEC2でインスタンスを作成する権限、削除する権限、変更する権限というように細かく権限が定義可能です。
IAMでは、IAMユーザーとIAMロールという二つの概念を抑えましょう。
IAMユーザーはユーザーに対して権限を管理します。
IAMロールは、AWSのサービス上で作成したものに対して権限を管理し、紐付けることでその効力を発揮します。
例えばデプロイ専用のサーバであれば、S3へのアクセス権限を持つデプロイロールを作成し、デプロイ専用のサーバにロールを付与します。

## 技術的情報収集

### ログを読もう

画面を見るということは対戦ゲームにおいては特に大事なことです。
もちろんコンピュータ上でのプログラミング時にも重要です。
画面を見ずに Enter Key を押したり、とりあえず sudo をぱなしていませんか。
適当に攻撃をぱなしているようでは、安定した勝利は得られません。
コンピュータも同じで、適当に Enter Key をぱなすようでは、効率はあがりません。

エラーが出た際には、メッセージを読んで、適切な対処をしましょう。
そして自分がコードを書く際にどのようなエラーメッセージを出せるとわかりやすいかの反面教師としましょう。

### 公式リファレンスを読もう

https://docs.python.org/ja/3/

情報共有サイトは有益な場合もあります。
しかしながら、できる限り仕様に関しては一次情報が大事です。
情報共有サイトから何気なくコピーしたコードには、特権ユーザを要求するものが少なくありません。
プラモデルを作る際に、一番に見るのが同梱されている説明書ではなく、ネット上の記事でしょうか。

ただし、公式リファレンスは全知全能という訳ではありません。
公式リファレンスと違う挙動をしたとき、それはバグだと考えられます。
昔ならコンピュータに読み込まれる紙テープに穴が空いてしまうという単純なものでしたが、今は複雑なプログラムにおいて想定外の挙動が起きているということです。
気が向いたらプルリクエストを出しましょう。

## おすすめ書籍

独断と偏見で選んだ全般で使えそうな書籍です。

* [実践 Python 3](https://www.oreilly.co.jp/books/9784873117393/)
* [Effective Python](https://www.oreilly.co.jp/books/9784873117560/)
* [Fluent Python](https://www.oreilly.co.jp/books/9784873118178/)
* [scikit-learn と TensorFlow による実践機械学習](https://www.oreilly.co.jp/books/9784873118345/)
* [Web制作者のためのGitHubの教科書](https://book.impress.co.jp/books/1114101005)
* [プリンシプル オブ プログラミング](https://www.shuwasystem.co.jp/book/9784798046143.html)
* [データサイエンティストの秘密ノート 35の失敗事例と克服法](https://www.sbcr.jp/product/4797389623/)
* [プログラマのためのDocker教科書](https://www.shoeisha.co.jp/book/detail/9784798153223)
* [テスト駆動Python](https://www.shoeisha.co.jp/book/detail/9784798157603)
